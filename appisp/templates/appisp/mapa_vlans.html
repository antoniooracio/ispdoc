{% extends "admin/base_site.html" %}
{% block content %}
<div class="card-body">
    <div class="form-group field-tipo">
        <div class="row">
            <div class="col-5">
                <label class="form-label">Empresa:</label>
                <select id="empresa-select">
                    <option value="">Limpar</option>
                </select>
            </div>
        </div>
        <div class="col-2">
            <label class="form-label">Vlan:</label>
            <select id="vlan-select" disabled>
                <option value="">Todas</option>
            </select>
        </div>
    </div>
</div>

<script src="https://d3js.org/d3.v6.min.js"></script>
<head>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        .equipamento { display: flex; align-items: center; padding: 10px; }
        .equipamento i { font-size: 24px; margin-right: 8px; }
        .vlan { background: #3498db; color: white; padding: 5px 10px; border-radius: 5px; margin: 5px; }

        svg { width: 100%; height: 100%; }
        .svg-container { width: 98vw; height: 90vh;}
        <style>

    /* Estiliza todos os selects */
    select {
        width: 100%;
        padding: 8px;
        border: 1px solid #ced4da;
        border-radius: 5px;
        background-color: #000;
        font-size: 16px;
        appearance: none; /* Remove o estilo padr√£o do navegador */
        -webkit-appearance: none;
        -moz-appearance: none;
    }

    /* Adiciona uma seta personalizada no select */
    .form-group select {
        background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24' height='24'><path fill='gray' d='M7 10l5 5 5-5z'/></svg>");
        background-repeat: no-repeat;
        background-position: right 10px center;
        background-size: 18px;
        padding-right: 30px;
    }

    /* Estiliza o hover e foco */
    select:hover, select:focus {
        border-color: #80bdff;
        box-shadow: 0 0 5px rgba(0, 123, 255, 0.25);
        outline: none;
    }

    /* Ajusta os selects dentro das colunas */
    .col-sm-7 select {
        width: 100%;
    }
    </style>
    </style>
</head>
<div class="card svg-container">
    <svg></svg>
</div>
<script>
    function carregarEmpresas() {
        fetch("{% url 'lista_empresas_json' %}")
            .then(response => response.json())
            .then(data => {
                const select = document.getElementById("empresa-select");
                select.innerHTML = '<option value="">Limpar</option>'; // Garante reset

                if (data.empresas.length === 0) {
                    document.querySelector(".svg-container").style.display = "none";
                    return;
                }

                document.querySelector(".svg-container").style.display = "block";

                data.empresas.forEach(empresa => {
                    let option = document.createElement("option");
                    option.value = empresa.id;
                    option.textContent = empresa.nome;
                    select.appendChild(option);
                });
            })
            .catch(error => console.error("Erro ao carregar empresas:", error));
    }


    function carregarVlans(empresaId) {
        const vlanSelect = document.getElementById("vlan-select");

        // Limpa o select antes de adicionar novas VLANs
        vlanSelect.innerHTML = '<option value="">Todas</option>';
        vlanSelect.disabled = !empresaId;

        if (!empresaId) return;

        fetch("{% url 'lista_vlans_json' %}?empresa_id=" + empresaId)
            .then(response => response.json())
            .then(data => {
                data.vlans.forEach(vlan => {
                    let option = document.createElement("option");
                    option.value = vlan.id;
                    option.textContent = vlan.numero + " - " + vlan.nome;
                    vlanSelect.appendChild(option);
                });

                vlanSelect.disabled = data.vlans.length === 0;
            })
            .catch(error => console.error("Erro ao carregar VLANs:", error));
    }


    function carregarMapaVlan(empresaId = "", vlanId = "") {
        fetch("{% url 'mapa_vlans_json' %}?empresa_id=" + empresaId + "&vlan_id=" + vlanId)
            .then(response => response.json())
            .then(data => {

                // Corrigido: Seleciona o container correto e recria o SVG
                d3.select(".svg-container").html('<svg></svg>');

                // Corrigido: Seleciona o novo SVG dentro do container
                const svg = d3.select(".svg-container svg")
                    .attr("width", 800)
                    .attr("height", 600);

                const g = svg.append("g");

                const zoom = d3.zoom()
                    .scaleExtent([0.5, 3])
                    .on("zoom", (event) => { g.attr("transform", event.transform); });

                svg.call(zoom);

                const equipamentos = data.equipamentos;
                equipamentos.forEach((equip, i) => {
                    let yEquip = i * 100 + 50;
                    g.append("rect").attr("x", 50).attr("y", yEquip - 15).attr("width", 200)
                        .attr("height", 50).attr("fill", "lightgray").attr("stroke", "black");
                    g.append("text").attr("x", 60).attr("y", yEquip).text(equip.equipamento)
                        .attr("font-size", "14px").attr("fill", "black");

                    equip.vlans.forEach((vlan, j) => {
                        let xVlan = 300, yVlan = j * 30 + 50;
                        g.append("line").attr("x1", 250).attr("y1", yEquip).attr("x2", xVlan)
                            .attr("y2", yVlan).attr("stroke", "blue");
                        g.append("circle").attr("cx", xVlan).attr("cy", yVlan).attr("r", 10).attr("fill", "red");
                        g.append("text").attr("x", xVlan + 15).attr("y", yVlan + 5)
                            .text(`VLAN ${vlan.vlan} - ${vlan.porta}`).attr("font-size", "12px").attr("fill", "black");
                    });
                });
            })
            .catch(error => console.error("Erro ao carregar VLANs:", error));
    }




    document.getElementById("empresa-select").addEventListener("change", (event) => {
        const empresaId = event.target.value;

        // Limpa o mapa se "Limpar" for selecionado (valor vazio)
        if (!empresaId) {
            d3.select(".svg-container").html('<svg></svg>');
            document.getElementById("vlan-select").innerHTML = '<option value="">Limpar</option>';
            document.getElementById("vlan-select").disabled = true;
            return;
        }

        carregarVlans(empresaId);
        carregarMapaVlan(empresaId, ""); // Sempre recarrega o mapa ao trocar empresa
    });

        document.getElementById("vlan-select").addEventListener("change", (event) => {
            const empresaId = document.getElementById("empresa-select").value;
            const vlanId = event.target.value;
            carregarMapaVlan(empresaId, vlanId); // Renderiza o mapa novamente ao mudar VLAN
        });

        carregarEmpresas();
        // carregarMapaVlan(); // Inicia carregando tudo
</script>

{% endblock %}
