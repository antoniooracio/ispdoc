<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa de Rede</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        .container {
            max-width: 95%;
            margin: auto;
            padding: 20px;
        }

        .rack-container {
            display: flex;
            flex-wrap: nowrap;
            gap: 20px;
            margin-top: 20px;
        }

        .rack {
            border: 1px solid #333;
            padding: 10px;
            background: #f8f9fa;
            width: 380px;
        }

        .rack h4 {
            text-align: center;
            margin-bottom: 10px;
        }

        .rack-content {
            display: flex;
            justify-content: space-between;
        }

        .rack-section {
            width: 48%;
        }

        .rack-title {
            font-weight: bold;
            text-align: center;
            background: #ddd;
            padding: 5px;
        }

        .rack-slot {
            border: 1px solid #666;
            padding: 5px;
            text-align: center;
            font-size: 14px;
            background: white;
            margin: 2px 0;
        }

        .rack-slot.ocupado {
            background: #ffc107;
        }

        form {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        select, button {
            padding: 5px;
            font-size: 14px;

        }
    </style>
</head>
<body>
    <div class="container">
        <h2 class="my-4">Visualização de Racks</h2>

        <!-- Formulário de filtro -->
        <form id="filtro-form">
    <label for="empresa">Empresa:</label>
    <select name="empresa" id="empresa">
        <option value="">Todas</option>
        {% for empresa in empresas %}
            <option value="{{ empresa.id }}" {% if empresa.id == empresa_id %}selected{% endif %}>{{ empresa.nome }}</option>
        {% endfor %}
    </select>

    <label for="pop">POP:</label>
    <select name="pop" id="pop">
        <option value="">Todos</option>
        {% for pop in pops %}
            <option value="{{ pop.id }}" {% if pop.id == pop_id %}selected{% endif %}>{{ pop.nome }}</option>
        {% endfor %}
    </select>

    <button type="submit" class="btn btn-primary">Filtrar</button>
</form>

        <div id="rack-container" class="rack-container"></div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            carregarRacks();

            document.getElementById("filtro-form").addEventListener("submit", function (event) {
                event.preventDefault();
                carregarRacks();
            });
        });

        function carregarRacks() {
            const empresaId = document.getElementById("empresa").value;
            const popId = document.getElementById("pop").value;

            let url = `/mapa-rack/dados/`;
            let params = [];

            if (empresaId) params.push(`empresa=${encodeURIComponent(empresaId)}`);
            if (popId) params.push(`pop=${encodeURIComponent(popId)}`);

            if (params.length > 0) {
                url += `?${params.join("&")}`;
            }

            console.log("URL de requisição:", url);  // Verifique se a URL está correta

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    console.log("Dados filtrados recebidos:", data);  // Verifique se os dados estão filtrados
                    renderizarMapaRack(data.racks);
                })
                .catch(error => console.error("Erro ao carregar racks:", error));
        }


        function renderizarMapaRack(racks) {
            const rackContainer = document.getElementById("rack-container");
            rackContainer.innerHTML = "";

            if (racks.length === 0) {
                rackContainer.innerHTML = "<p>Nenhum rack encontrado.</p>";
                return;
            }

            racks.forEach(rack => {
                const rackDiv = document.createElement("div");
                rackDiv.className = "rack";
                rackDiv.innerHTML = `<h4>${rack.nome}</h4>`;

                let usFrente = [];
                let usTras = [];
                for (let i = rack.us; i >= 1; i--) {
                    usFrente.push({ numero: i, equipamento: null });
                    usTras.push({ numero: i, equipamento: null });
                }

                rack.equipamentos.forEach(equip => {
                    for (let i = equip.u_inicio; i <= equip.u_fim; i++) {
                        if (equip.lado === "Frente") {
                            let u = usFrente.find(slot => slot.numero === i);
                            if (u) u.equipamento = equip.nome;
                        } else if (equip.lado === "Trás") {
                            let u = usTras.find(slot => slot.numero === i);
                            if (u) u.equipamento = equip.nome;
                        }
                    }
                });

                rackDiv.innerHTML += `
                    <div class="rack-content">
                        <div class="rack-section">
                            <div class="rack-title">Frente</div>
                            ${usFrente.map(u => `
                                <div class="rack-slot ${u.equipamento ? 'ocupado' : ''}">
                                    ${u.numero}
                                    ${u.equipamento ? `<br>${u.equipamento}` : ""}
                                </div>
                            `).join("")}
                        </div>

                        <div class="rack-section">
                            <div class="rack-title">Trás</div>
                            ${usTras.map(u => `
                                <div class="rack-slot ${u.equipamento ? 'ocupado' : ''}">
                                    ${u.numero}
                                    ${u.equipamento ? `<br>${u.equipamento}` : ""}
                                </div>
                            `).join("")}
                        </div>
                    </div>
                `;

                rackContainer.appendChild(rackDiv);
            });
        }
    </script>
</body>
</html>
