{% extends "admin/base_site.html" %}
{% block content %}
{% csrf_token %}
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa de Rede</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://cdn.ckeditor.com/ckeditor5/39.0.1/classic/ckeditor.js"></script>

    <style>

        element.style {
            width: 90%;
        }

        .btn {
            display: inline-block;
            padding: 8px 16px;
            font-size: 16px;
            font-weight: bold;
            text-align: center;
            text-decoration: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn-primary {
            background-color: #007bff;
            color: #fff;
            border: 1px solid #007bff;
        }

            .btn-primary:hover {
                background-color: #0056b3;
                border-color: #004085;
            }

        #mapa {
            width: 100%;
            height: 1024px;
            border: 1px solid #ccc;
            background-color: #ecf0f0;
        }

        .equipamento {
            cursor: pointer;
            transition: transform 0.2s;
        }

            .equipamento:hover {
                cursor: pointer;
                stroke: #007bff;
                stroke-width: 4px;
            }

        .porta {
            fill: #007bff;
            cursor: pointer;
        }

            .porta:hover {
                fill: #0056b3;
            }

        /* Estilo para o modal */
        .modal {
            display: none;
            position: fixed;
            top: 40%;
            left: 50%;
            transform: translate(-30%, -40%);
            background-color: #454d55;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            width: 550px;
            height: auto;
            z-index: 1000;
        }

            .modal.show {
                display: block;
            }

        .modal-header {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-footer {
            text-align: right;
        }

        .close-modal {
            background-color: #ff4d4d;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
        }

            .close-modal:hover {
                background-color: #cc0000;
            }

        /* Estilo de fundo para o efeito de overlay */
        .modal-overlay {
            position: fixed;
            background-color: #454d55;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none; /* Inicialmente oculto */
        }

        /* Estilo do modal de conex√£o */
        .modal-conexao {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%); /* Centraliza o modal */
            background-color: #454d55;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

            /* Tornar o modal vis√≠vel */
            .modal-conexao.show {
                display: block;
            }

        /* Cabe√ßalho do modal */
        .modal-conexao-header {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        select {
            padding: 5px;
            font-size: 14px;
            background-color: #343a40;
            color: #fff;
        }

        /* Corpo do modal */
        .modal-conexao-body {
            margin-bottom: 20px;
        }

        .modal-body .form-group {
            margin-bottom: 15px;
        }
        /* Rodap√© do modal */
        .modal-conexao-footer {
            text-align: right;
        }

        /* Estilo do bot√£o de fechar */
        .close-conexao-modal {
            background-color: #ff4d4d;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
        }

            .close-conexao-modal:hover {
                background-color: #cc0000;
            }

        /* Estilo de fundo para o efeito de overlay */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none; /* Inicialmente oculto */
        }
        .dark-mode .modal-content{
            padding: 30px;
        }
        .dark-mode select{
            background-color: #fff;
            color: #000;
            border-color: #fff;
        }

        @media (max-width: 2800px) {
            .modal {
                width: 650px;
            }

            .modal-conexao {
                width: 650px;
            }
        }

        @media (max-width: 1400px) {
            .modal {
                width: 650px;
            }

            .modal-conexao {
                width: 650px;
            }
        }

        @media (max-width: 1200px) {
            .modal {
                width: 550px;
            }

            .modal-conexao {
                width: 550px;
            }
        }

        @media (max-width: 900px) {
            .modal {
                width: calc(60% - 30px);
            }

            .modal-conexao {
                width: calc(60% - 30px);
            }
        }

        @media (max-width: 600px) {
            .modal {
                width: 80%;
            }

            .modal-conexao {
                width: 80%;
            }
        }

        .ck.ck-toolbar {
            background-color: #212529 !important; /* Fundo escuro para combinar com Bootstrap Dark */
            color: #ffffff !important; /* Texto branco */
            border-bottom: 1px solid #6c757d !important;
        }

        .ck.ck-toolbar .ck-button {
            color: #ffffff !important; /* √çcones e textos brancos */
        }

        .ck.ck-toolbar .ck-button:hover {
            background-color: #495057 !important; /* Fundo ao passar o mouse */
        }
        .ck-editor__editable {
            min-height: 150px !important; /* Altura m√≠nima */
            max-height: 300px !important; /* Evita que cres√ßa demais */
            overflow-y: auto !important; /* Adiciona rolagem se necess√°rio */
            background-color: #fff !important; /* Fundo escuro para combinar com Bootstrap Dark */
            color: #000 !important; /* Texto branco */
            border: 1px solid #6c757d !important; /* Borda para separar do fundo */
        }

        .ck.ck-toolbar {
            background-color: #212529 !important; /* Fundo da barra de ferramentas */
            border-bottom: 1px solid #6c757d !important;
        }

        .ck.ck-editor__editable:focus {
            outline: none !important; /* Remove o contorno azul ao clicar */
        }
    </style>
</head>
<body>

<a href="/admin/" class="btn btn-primary" style="width: -webkit-fill-available;">FECHAR O MAPA</a>
<!-- Exibe select da Empresa e Bot√£o de Fechar o mapa-->
<div style="display: flex; align-items: center; gap: 10px; margin: 10px;">
    <select id="empresa-selector">
        <option value="">Selecione uma Empresa</option>
        {% for empresa in empresas %}
        <option value="{{ empresa.id }}">{{ empresa.nome }}</option>
        {% endfor %}
    </select>

</div>
<div style="display: flex; align-items: center; gap: 10px; margin: 10px; ">
    <label for="zoom-slider">Zoom:</label>
    <input type="range" id="zoom-slider" min="0.5" max="3" step="0.1" value="1" style="width: 200px;">
</div>
<div style="display: flex; align-items: center; gap: 20px; margin-bottom: 10px;">
    <!-- Switch -->
    <div style="display: flex; flex-direction: column; align-items: center;">
        <svg width="30" height="30">
            <rect width="30" height="30" fill="blue"></rect>
        </svg>
        <span>Switch</span>
    </div>

    <!-- Servidor -->
    <div style="display: flex; flex-direction: column; align-items: center;">
        <svg width="40" height="30">
            <rect width="40" height="20" x="0" y="5" fill="gray"></rect>
            <line x1="5" y1="10" x2="35" y2="10" stroke="black"/>
            <line x1="5" y1="20" x2="35" y2="20" stroke="black"/>
        </svg>
        <span>Servidor</span>
    </div>

    <!-- OLT -->
    <div style="display: flex; flex-direction: column; align-items: center;">
        <svg width="40" height="20">
            <rect width="35" height="15" x="2.5" y="2.5" fill="purple"></rect>
            <circle cx="10" cy="15" r="2" fill="yellow"></circle>
            <circle cx="20" cy="15" r="2" fill="yellow"></circle>
            <circle cx="30" cy="15" r="2" fill="yellow"></circle>
        </svg>
        <span>OLT</span>
    </div>
</div>
<div style="display: flex; align-items: center; gap: 20px; margin: 10px;">
    <!-- Roteador / AP -->
    <div style="display: flex; flex-direction: column; align-items: center;">
        <svg width="30" height="30">
            <!-- C√≠rculo -->
            <circle cx="15" cy="15" r="15" fill="green"></circle>

            <!-- Linha diagonal 1 (parte do "X") -->
            <line x1="8" y1="8" x2="22" y2="22" stroke="white" stroke-width="2"></line>

            <!-- Linha diagonal 2 (parte do "X") -->
            <line x1="8" y1="22" x2="22" y2="8" stroke="white" stroke-width="2"></line>
        </svg>
        <span>Roteador/AP</span>
    </div>

    <!-- Passivo -->
    <div style="display: flex; flex-direction: column; align-items: center;">
        <svg width="30" height="30">
            <path d="M 0,30 L 30,30 L 15,0 Z" fill="orange"></path>
        </svg>
        <span>Passivo</span>
    </div>

    <!-- Transporte -->
    <div style="display: flex; flex-direction: column; align-items: center;">
        <svg width="40" height="30">
            <path d="M5 15 A10 10 0 0 1 20 15 A10 10 0 0 1 35 15 A10 10 0 0 1 30 25 A10 10 0 0 1 10 25 A10 10 0 0 1 5 15 Z"
                  fill="#00F5FF"></path>
        </svg>
        <span>Transporte</span>
    </div>
</div>
<!-- Bot√£o de voltar para a p√°gina inicial -->

<!-- Renderiza o mapa na tela-->
<div id="mapa">
    <!-- <img src="/IDX.png" alt="Fundo do Mapa" style="width: 100%; height: 100%; object-fit: cover;"> -->
</div>

<!-- Modal de Detalhes do Equipamento -->
<div class="modal-overlay" id="modalOverlay"></div>
<div class="modal" id="modalEquipamento">
    <div class="modal-header">
        Equipamento {nome}
    </div>
    <div class="modal-body">
        <form>
            <div class="form-group row">
                <label for="input-ip" class="col-sm-2 col-form-label">IP</label>
                <div class="col-sm-10">
                    <input type="text" class="form-control" id="input-ip" readonly>
                </div>
            </div>

            <div class="form-group row">
                <label for="input-usuario" class="col-sm-2 col-form-label">Usu√°rio</label>
                <div class="col-sm-10">
                    <input type="text" class="form-control" id="input-usuario" readonly>
                </div>
            </div>

            <div class="form-group row">
                <label for="input-senha" class="col-sm-2 col-form-label">Senha</label>
                <div class="input-group-prepend">
                    <button type="button"
                            class="btn"
                            onclick="toggleModalPassword('input-senha', this)"
                            title="Mostrar/Ocultar Senha">
                        üëÅ
                    </button>
                </div>
                <div class="col-sm-8">
                    <div class="input-group">

                        <input type="password" class="form-control" id="input-senha" readonly>
                    </div>
                </div>
            </div>

            <div class="form-group row">
                <label for="input-porta" class="col-sm-2 col-form-label">Porta</label>
                <div class="col-sm-10">
                    <input type="text" class="form-control" id="input-porta" readonly>
                </div>
            </div>

            <div class="form-group row">
                <label for="input-protocolo" class="col-sm-2 col-form-label">Protocolo</label>
                <div class="col-sm-10">
                    <input type="text" class="form-control" id="input-protocolo" readonly>
                </div>
            </div>

            <div class="form-group row">
                <label for="input-pop" class="col-sm-2 col-form-label">Pop</label>
                <div class="col-sm-10">
                    <input type="text" class="form-control" id="input-pop" readonly>
                </div>
            </div>

            <div class="form-group row">
                <label for="input-observacao" class="col-sm-2 col-form-label">Observa√ß√£o</label>
                <div class="col-sm-10">
                    <textarea class="form-control" rows="5" id="input-observacao" readonly></textarea>
                </div>
            </div>
        </form>

    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-danger" id="closeModal">Fechar</button>
    </div>
</div>

<!-- Modal de Detalhes de Conex√£o -->
<div class="modal-overlay" id="modalOverlayConexao"></div>
<div class="modal-conexao" id="modalConexao">
    <div class="modal-header">
        <div class="modal-conexao-header">
            Conex√£o: {tipo}
        </div>
    </div>

    <div class="modal-conexao-body px-3 py-2">
        <div class="mb-2 row">
            <label class="col-sm-3 col-form-label"><strong>Tipo:</strong></label>
            <div class="col-sm-9 col-form-label">{tipo}</div>
        </div>
        <div class="mb-2 row">
            <label class="col-sm-3 col-form-label"><strong>Velocidade:</strong></label>
            <div class="col-sm-9 col-form-label">{velocidade}</div>
        </div>
        <div class="mb-2 row">
            <label class="col-sm-3 col-form-label"><strong>Fonte:</strong></label>
            <div class="col-sm-9 col-form-label">{fonte}</div>
        </div>
        <div class="mb-2 row">
            <label class="col-sm-3 col-form-label"><strong>Destino:</strong></label>
            <div class="col-sm-9 col-form-label">{destino}</div>
        </div>
    </div>

    <div class="modal-conexao-footer">
        <div class="modal-footer">
            <button type="button" class="btn btn-outline-warning" id="excluirConexaoBtn">Excluir Conex√£o</button>

            <button type="button" class="btn btn-danger" id="fecharConexaoBtn">Fechar</button>
        </div>
    </div>
</div>

<!-- Modal de DropDown List para portas-->
<div class="col-12 col-lg-12">
    <div class="card">
        <div class="card-body">
            <form method="post" class="form-horizontal" style="pading:20px;">
                <div id="portaModal" class="modal" style="display:none;">
                    <div class="modal-content">

                        <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

                        <h3>Conex√£o de portas</h3></br>


                        <div class="form-group field-tipo">
                            <div class="row">
                                <div class="col-sm-4 text-left">
                                    <label for="porta-dropdown">Porta de Origem</label>
                                </div>
                                <div class="col-sm-8">
                                    <select id="porta-dropdown">
                                        <option value="">Selecione uma porta</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="form-group field-tipo">
                            <div class="row">
                                <div class="col-sm-4 text-left">
                                    <label for="equipamento-dropdown">Equipamento Destino</label>
                                </div>
                                <div class="col-sm-8">
                                    <select id="equipamento-dropdown">
                                        <option value="">Selecione um equipamento</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="form-group field-tipo">
                            <div class="row">
                                <div class="col-sm-4 text-left">
                                    <label for="porta-destino-dropdown" class="form-label">Porta de Destino</label>
                                </div>
                                <div class="col-sm-8">
                                    <select id="porta-destino-dropdown">
                                        <option value="">Selecione uma porta</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="form-group field-tipo">
                            <div class="row">
                                <div class="col-sm-4 text-left">
                                    <label for="observacao" class="form-label">Observa√ß√£o</label>
                                </div>
                                <div class="col-sm-8">
                                    <textarea id="observacao" class="form-control" rows="5" style="width: 100%;"
                                              placeholder="Digite uma observa√ß√£o ..."></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="form">
                            <button id="conectar" type="button" class="btn btn-primary">Conectar Portas</button>
                            <!-- Bot√£o para fechar o modal -->
                            <button id="closeModalConexao" type="button" class="btn btn-danger close-modal-button">
                                Fechar
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    let editorObservacao;  // Vari√°vel global

    ClassicEditor
        .create(document.querySelector('#observacao'), {
            toolbar: ['bold', 'italic', 'link', 'bulletedList', 'numberedList', 'undo', 'redo']
        })
        .then(editor => {
            editorObservacao = editor;

            const editable = editor.ui.view.editable.element;
            editable.style.minHeight = '150px';
            editable.style.maxHeight = '300px';
            editable.style.overflowY = 'auto';
            editable.style.backgroundColor = '#ffffff'; // fundo branco
            editable.style.color = '#000000'; // texto preto
            editable.style.border = '1px solid #6c757d';
        })
        .catch(error => {
            console.error('Erro ao inicializar o editor:', error);
        });
</script>


<script src="https://d3js.org/d3.v7.min.js"></script>

<script>
    const userIsAdmin = {{ userIsAdmin|yesno:"true,false" }};
    console.log(userIsAdmin);  // Verifique se est√° correto

    const nodes = {{ nodes|safe }};
    const links = {{ links|safe }};
    const mapa = d3.select('#mapa');

    let zoomTransform = d3.zoomIdentity; // Vari√°vel global para armazenar o estado do zoom

    function atualizarMapa() {
        fetch('/api/get_map_data/')  // Substitua pela URL correta no seu Django
            .then(response => response.json())
            .then(data => {
                nodes.length = 0;  // Esvazia o array existente
                links.length = 0;

                nodes.push(...data.nodes);  // Adiciona os novos dados
                links.push(...data.links);

                renderMapa();  // Re-renderiza o mapa com os dados atualizados
            })
            .catch(error => console.error('Erro ao atualizar o mapa:', error));
    }

// Fun√ß√£o para carregar as posi√ß√µes salvas
function carregarPosicoes() {
    const posicoesSalvas = localStorage.getItem('posicoesEquipamentos');
    if (posicoesSalvas) {
        const posicoes = JSON.parse(posicoesSalvas);
        nodes.forEach((node) => {
            const posicaoSalva = posicoes.find(p => p.id === node.id);
            if (posicaoSalva) {
                node.x = posicaoSalva.x;
                node.y = posicaoSalva.y;
            }
        });
    }
}

// Fun√ß√£o para salvar as posi√ß√µes
function salvarPosicoes() {
    const posicoes = nodes.map(node => ({
        id: node.id,
        x: node.x,
        y: node.y
    }));
    localStorage.setItem('posicoesEquipamentos', JSON.stringify(posicoes));
}

function limparMapa() {
    d3.select("#mapa").selectAll("*").remove();
}

function renderMapa() {
    carregarPosicoes();

    const empresaId = document.getElementById('empresa-selector').value;

    // Filtrar os equipamentos pela empresa selecionada
    const equipamentosFiltrados = empresaId
        ? nodes.filter(equipamento => equipamento.empresa === parseInt(empresaId))
        : [];  // Quando n√£o h√° empresa selecionada, n√£o mostra nenhum equipamento

    // Filtrar as conex√µes pela empresa selecionada
    const conexoesFiltradas = empresaId
        ? links.filter(link => {
            const sourceEquipamento = nodes.find(node => node.id === link.source);
            const targetEquipamento = nodes.find(node => node.id === link.target);
            return (sourceEquipamento.empresa === parseInt(empresaId) && targetEquipamento.empresa === parseInt(empresaId));
        })
        : [];  // Quando n√£o h√° empresa selecionada, n√£o mostra nenhuma conex√£o

    // Salvar o estado do zoom antes de limpar o mapa
    const svgElement = d3.select('#mapa svg');
    if (!svgElement.empty()) {
        zoomTransform = d3.zoomTransform(svgElement.node());
    }

    mapa.selectAll('*').remove();  // Limpar mapa antes de renderizar

    const width = mapa.node().offsetWidth || 800;
    const height = mapa.node().offsetHeight || 600;

    const svg = mapa.append('svg')
        .attr('width', width)
        .attr('height', height);

    const g = svg.append('g');

    const zoom = d3.zoom()
        .scaleExtent([0.5, 3])
        .on('zoom', (event) => {
            g.attr('transform', event.transform);
            document.getElementById('zoom-slider').value = event.transform.k;
            zoomTransform = event.transform; // Atualizar a transforma√ß√£o do zoom
        });

    svg.call(zoom);

    // Restaurar o zoom anterior
    svg.call(zoom.transform, zoomTransform);

    // Conecta o slider ao zoom
    document.getElementById('zoom-slider').addEventListener('input', (event) => {
        const newZoom = parseFloat(event.target.value);
        svg.transition().duration(200).call(zoom.scaleTo, newZoom);
    });

    const drag = d3.drag()
        .on('start', dragStarted)
        .on('drag', dragged)
        .on('end', dragEnded);

    // Armazenar as conex√µes j√° criadas
    let conexoesCriadas = [];

    // Fun√ß√£o para calcular uma curva entre os pontos de conex√£o
    function calcularCurva(x1, y1, x2, y2, index) {
        const offset = index * 5;  // Cada conex√£o ter√° um deslocamento diferente para a curvatura
        const controlX = (x1 + x2) / 2;
        const controlY = (y1 + y2) / 2 - offset;
        return [[x1, y1], [controlX, controlY], [x2, y2]];
    }

    // Cria√ß√£o de um mapa para contar as conex√µes entre os pares de equipamentos
    const conexaoContagem = {};

    // Fun√ß√£o para contar conex√µes entre os pares de equipamentos
    function contarConexoes(link) {
        const key = `${Math.min(link.source, link.target)}-${Math.max(link.source, link.target)}`;
        if (conexaoContagem[key]) {
            conexaoContagem[key]++;
        } else {
            conexaoContagem[key] = 1;
        }
    }

    // Renderizar as linhas de conex√£o com curvaturas, agora filtradas pela empresa
    const linhasConexao = g.selectAll('.linha-conexao')
        .data(conexoesFiltradas)
        .enter()
        .filter(d => {
            const sourceId = d.source;
            const targetId = d.target;
            const portaOrigem = d.porta_origem;
            const portaDestino = d.porta_destino;

            // Verifica se essa conex√£o j√° foi criada (evita adicionar linha duplicada)
            const conexaoExistente = conexoesCriadas.some(conexao =>
                (conexao.source === sourceId && conexao.target === targetId && conexao.portaOrigem === portaOrigem && conexao.portaDestino === portaDestino) ||
                (conexao.source === targetId && conexao.target === sourceId && conexao.portaOrigem === portaDestino && conexao.portaDestino === portaOrigem)
            );

            if (!conexaoExistente) {
                // Adiciona a conex√£o ao array de conex√µes j√° criadas
                conexoesCriadas.push({ source: sourceId, target: targetId, portaOrigem, portaDestino });
                // Conta a conex√£o entre os dois equipamentos
                contarConexoes(d);
            }

            return !conexaoExistente;  // Retorna true para desenhar a linha apenas se a conex√£o ainda n√£o foi criada
        })
        .append('path')
        .attr('class', 'linha-conexao')
        .attr('d', function (d, i) {
            const x1 = nodes.find(node => node.id === d.source).x;
            const y1 = nodes.find(node => node.id === d.source).y;
            const x2 = nodes.find(node => node.id === d.target).x;
            const y2 = nodes.find(node => node.id === d.target).y;

            const key = `${Math.min(d.source, d.target)}-${Math.max(d.source, d.target)}`;
            const conexaoCount = conexaoContagem[key];

            if (conexaoCount === 1) {
                // Se houver apenas uma conex√£o entre os equipamentos, a linha ser√° reta
                return `M ${x1},${y1} L ${x2},${y2}`;
            }

            const direction = i % 2 === 0 ? 1 : -1; // Alternar entre cima e baixo
            const intensity = (Math.floor(i / 2) * 10) + 5; // Aumenta a curvatura progressivamente

            const cx = (x1 + x2) / 2;
            const cy = (y1 + y2) / 2 + (direction * intensity); // Ajuste do ponto de controle

            return `M ${x1},${y1} Q ${cx},${cy} ${x2},${y2}`; // Curva B√©zier Quadr√°tica
        })
        .attr('stroke', d => {
            switch (d.tipo) {
                case 'Fibra': return 'blue';
                case 'Eletrico': return 'green';
                case 'Radio': return 'orange';
                case 'Transporte': return 'brown';
                default: return 'gray';
            }
        })
        .attr('stroke-width', d => {
            const widthMap = {
                '10G': 3,
                '20G': 4,
                '40G': 5,
                '100G': 6
            };
            return widthMap[d.speed] || 2;
        })
        .attr('fill', 'none')
        .on('click', function (event, d) {
            mostrarInformacoesConexao(d);
        });


function excluirConexao(portaId) {
    const empresaId = document.getElementById('empresa-selector').value;
    localStorage.setItem('empresaSelecionada', empresaId);

    fetch('/api/desconectar-portas/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ porta_id: portaId })  // <- Aqui est√° o nome correto esperado no backend
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Conex√£o exclu√≠da com sucesso!');
            // Esconde o modal antes de recarregar a p√°gina
            document.getElementById('modalConexao').classList.remove('show');
            document.getElementById('modalOverlayConexao').style.display = 'none';

            // Pequeno delay para garantir que o modal feche antes do reload
            setTimeout(() => {
                location.reload();
            }, 100);
        } else {
            alert('Erro ao excluir: ' + (data.error || 'Erro desconhecido.'));
        }
    })
    .catch(error => {
        console.error('Erro ao excluir conex√£o:', error);
        alert('Erro na requisi√ß√£o.');
    });
}

    // Renderizar os equipamentos
    const equipamentosG = g.selectAll('.equipamento')
        .data(equipamentosFiltrados)
        .enter().append('g')
        .attr('class', 'equipamento')
        .attr('transform', d => `translate(${d.x},${d.y})`)
        .call(drag)
        .on('click', function(event, d) {
            // Clique com o bot√£o esquerdo (mantenha o evento original)
            if (userIsAdmin) {
                showModal(event, d);
            } else {
                alert("Voc√™ n√£o tem permiss√£o para visualizar essas informa√ß√µes.");
            }
        })
        .on('contextmenu', function(event, d) {
            // Clique com o bot√£o direito do mouse
            handleRightClick(event, d);
        });

    // Renderiza os √≠cones no mapa
    equipamentosG.each(function(d) {
        const grupo = d3.select(this);

        if (d.tipo === "Transporte") {
            // √çcone de nuvem
            grupo.append('path')
                .attr('d', 'M20 10 A10 10 0 0 1 40 10 A10 10 0 0 1 60 10 A10 10 0 0 1 50 30 A10 10 0 0 1 30 30 A10 10 0 0 1 20 10 Z')
                .attr('fill', d.status === 'Ativo' ? '#4B0082' : 'red') // Roxo escuro
                .attr('transform', 'scale(0.9) translate(-30, -20)');

        } else if (d.tipo === "Switch") {
            // Quadrado
            grupo.append('rect')
                .attr('width', 30)
                .attr('height', 30)
                .attr('x', -15)
                .attr('y', -15)
                .attr('fill', d.status === 'Ativo' ? 'blue' : 'red');

        } else if (d.tipo === "Passivo") {
            // Tri√¢ngulo
            grupo.append('path')
                .attr('d', 'M -15,15 L 15,15 L 0,-15 Z') // Desenha um tri√¢ngulo
                .attr('fill', 'orange');

        } else if (d.tipo === "Servidor") {
            // Ret√¢ngulo horizontal com linhas (simulando um rack de servidor)
            grupo.append('rect')
                .attr('width', 40)
                .attr('height', 20)
                .attr('x', -20)
                .attr('y', -10)
                .attr('fill', d.status === 'Ativo' ? 'gray' : 'red');

            // Linhas no servidor para simular baias
            grupo.append('line').attr('x1', -15).attr('y1', -5).attr('x2', 15).attr('y2', -5).attr('stroke', 'black');
            grupo.append('line').attr('x1', -15).attr('y1', 5).attr('x2', 15).attr('y2', 5).attr('stroke', 'black');

        } else if (d.tipo === "VMWARE") {
            // Ret√¢ngulo horizontal com linhas (simulando um rack de servidor)
            grupo.append('rect')
                .attr('width', 40)
                .attr('height', 20)
                .attr('x', -20)
                .attr('y', -10)
                .attr('fill', d.status === 'Ativo' ? 'gray' : 'red');

            // Linhas no servidor para simular baias
            grupo.append('line').attr('x1', -15).attr('y1', -5).attr('x2', 15).attr('y2', -5).attr('stroke', 'black');
            grupo.append('line').attr('x1', -15).attr('y1', 5).attr('x2', 15).attr('y2', 5).attr('stroke', 'black');

        } else if (d.tipo === "Olt") {
            // Ret√¢ngulo pequeno representando uma OLT
            grupo.append('rect')
                .attr('width', 35)
                .attr('height', 15)
                .attr('x', -17.5)
                .attr('y', -7.5)
                .attr('fill', d.status === 'Ativo' ? 'purple' : 'red');

            // C√≠rculos representando portas √≥pticas
            for (let i = -10; i <= 10; i += 10) {
                grupo.append('circle')
                    .attr('cx', i)
                    .attr('cy', 5)
                    .attr('r', 2)
                    .attr('fill', 'yellow');
            }

            } else {
                // C√≠rculo para os demais tipos
                grupo.append('circle')
                    .attr('r', 20)
                    .attr('fill', d.status === 'Ativo' ? 'green' : 'red'); // Roxo escuro para ativo

                // Adiciona o "X" dentro do c√≠rculo
                grupo.append('line')
                    .attr('x1', -10)
                    .attr('y1', -10)
                    .attr('x2', 10)
                    .attr('y2', 10)
                    .attr('stroke', 'white')
                    .attr('stroke-width', 3);

                grupo.append('line')
                    .attr('x1', -10)
                    .attr('y1', 10)
                    .attr('x2', 10)
                    .attr('y2', -10)
                    .attr('stroke', 'white')
                    .attr('stroke-width', 3);
            }
    });

    equipamentosG.append('text')
        .text(d => d.nome)
        .attr('x', 25)
        .attr('y', 0)
        .style('font-size', '12px')
        .style('pointer-events', 'none');

// Fun√ß√£o para exibir o modal e carregar as portas livres do equipamento escolhido
function handleRightClick(event, equipamentoId) {
    event.preventDefault(); // Prevenir o menu de contexto padr√£o

    const empresaId = document.getElementById('empresa-selector').value;

    if (!equipamentoId || !equipamentoId.id || !empresaId) {
        alert('ID do equipamento ou ID da empresa inv√°lidos!');
        return;
    }

    // Corrigido: pegar o ID correto do objeto
    const equipamentoIdNum = parseInt(equipamentoId.id);
    const empresaIdNum = parseInt(empresaId);

    // Busca o equipamento correto dentro da lista de nodes
    const equipamento = nodes.find(node => parseInt(node.id) === equipamentoIdNum);

    if (!equipamento) {
        alert(`Equipamento com ID ${equipamentoIdNum} n√£o encontrado na lista de nodes.`);
        return;
    }

    if (parseInt(equipamento.empresa) !== empresaIdNum) {
        alert('Equipamento n√£o pertence √† empresa selecionada!');
        return;
    }

    // Obter as portas livres do equipamento
    fetch(`/api/portas?equipamento_id=${equipamentoIdNum}&empresa_id=${empresaIdNum}`)
        .then(response => {
            if (!response.ok) {
                return Promise.reject('Falha ao buscar as portas livres.');
            }
            return response.json();
        })
        .then(data => {

            if (data.error) {
                alert(data.error);
                document.getElementById('portaModal').style.display = "none";
                return;
            }

            if (!Array.isArray(data)) {
                alert('Ocorreu um erro ao processar as portas livres.');
                return;
            }

            filtrarEquipamentosPorEmpresa();

            const portaDropdown = document.getElementById('porta-dropdown');
            const portaModal = document.getElementById('portaModal');
            const closeModal = document.getElementById('closeModal');
            const conectarButton = document.getElementById('conectar');

            if (!portaDropdown || !portaModal || !closeModal || !conectarButton) {
                return; // Se algum desses elementos n√£o existir, a fun√ß√£o termina
            }

            portaDropdown.innerHTML = '<option value="">Selecione uma porta</option>';

            data.forEach(porta => {
                const option = document.createElement('option');
                option.value = porta.id;
                option.textContent = `${porta.nome} - ${porta.tipo} - ${porta.speed}`;
                portaDropdown.appendChild(option);
            });

            portaModal.style.display = "block"; // Exibir o modal

            // Agora, verificamos se o bot√£o "Conectar" existe antes de adicionar o eventListener
            if (conectarButton) {
                conectarButton.addEventListener('click', function(event) {
                    event.preventDefault(); // Previne o envio do formul√°rio e recarregamento da p√°gina

                    const portaOrigemId = localStorage.getItem('portaOrigemSelecionada');
                    const portaDestinoId = localStorage.getItem('portaDestinoSelecionada');
                    // Capturar o valor correto do CKEditor antes de enviar
                    // const editor = ClassicEditor.instances['observacao'];
                    const observacao = editorObservacao ? editorObservacao.getData() : '';  // Obt√©m o conte√∫do do CKEditor

                    // Verifique se a porta de origem e destino est√£o selecionadas e a observa√ß√£o foi preenchida
                    if (portaOrigemId && portaDestinoId && observacao) {
                        conectarPortas(portaOrigemId, portaDestinoId, observacao);
                    } else {
                        alert('Por favor, selecione uma porta de origem e uma de destino, juntamente com a observa√ß√£o.');
                    }
                });
            }

            // Ao clicar no bot√£o "Fechar"
            const closeModalButton = document.getElementById('closeModalConexao');
            if (closeModalButton) {
                closeModalButton.addEventListener('click', function() {
                    const portaModal = document.getElementById('portaModal');
                    portaModal.style.display = "none"; // Fecha o modal
                });
            }

            // Fechar o modal ao clicar fora dele
            window.onclick = function(event) {
                const portaModal = document.getElementById('portaModal');
                if (event.target == portaModal) {
                    portaModal.style.display = "none"; // Fecha o modal
                }
            };

            // Armazenar as sele√ß√µes no localStorage
            portaDropdown.addEventListener('change', function() {
                const portaOrigemSelecionada = portaDropdown.value;
                localStorage.setItem('portaOrigemSelecionada', portaOrigemSelecionada);
            });

            const portaDestinoDropdown = document.getElementById('porta-destino-dropdown');
            const equipamentoDestinoDropdown = document.getElementById('equipamento-destino-dropdown');

            portaDestinoDropdown.addEventListener('change', function() {
                const portaDestinoSelecionada = portaDestinoDropdown.value;
                localStorage.setItem('portaDestinoSelecionada', portaDestinoSelecionada);
            });

            equipamentoDestinoDropdown.addEventListener('change', function() {
                const equipamentoDestinoSelecionado = equipamentoDestinoDropdown.value;
                localStorage.setItem('equipamentoDestinoSelecionado', equipamentoDestinoSelecionado);
            });

        })
        .catch(error => {
            //alert('Ocorreu um erro ao tentar buscar as portas livres.');
        });
}


// Fun√ß√£o para conectar as portas, agora com os dados necess√°rios
function conectarPortas(portaOrigemId, portaDestinoId, observacao) {
    // Definindo o payload com os dados corretos que a API espera
    const payload = {
        porta_origem_id: portaOrigemId,
        porta_destino_id: portaDestinoId,
        observacao: observacao  // Enviando apenas os dados necess√°rios
    };

    fetch('/api/conectar-portas/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()  // Adicionando o CSRF Token
        },
        body: JSON.stringify(payload),  // Passando o payload correto
        credentials: 'same-origin'  // Garantir que os cookies sejam enviados corretamente
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            alert(data.message);
            // Fechar o modal ap√≥s a conex√£o ser bem-sucedida
            location.reload();
            const portaModal = document.getElementById('portaModal');
            portaModal.style.display = "none"; // Fecha o modal
        } else {
            alert("Erro ao conectar portas: " + (data.error || "Erro desconhecido"));
        }
    })
    .catch(error => {
        alert("Ocorreu um erro ao tentar conectar as portas.");
    });
}

// fun√ß√£o para filtrar os equipamentos e mostrar no DropDown
function filtrarEquipamentosPorEmpresa() {
    const empresaId = document.getElementById('empresa-selector').value;

    // Filtrar os equipamentos pela empresa selecionada
    const equipamentosFiltrados = empresaId
        ? nodes.filter(equipamento => equipamento.empresa === parseInt(empresaId))
        : [];  // Caso nenhum empresa seja selecionada, n√£o mostra equipamentos

    const equipamentosDropdown = document.getElementById('equipamento-dropdown');
    equipamentosDropdown.innerHTML = '<option value="">Selecione um equipamento</option>'; // Resetar dropdown

    // Adiciona as op√ß√µes de equipamentos ao dropdown
    equipamentosFiltrados.forEach(equipamento => {
        const option = document.createElement('option');
        option.value = equipamento.id;
        option.textContent = `${equipamento.nome} - ${equipamento.tipo} - ${equipamento.status}`;
        equipamentosDropdown.appendChild(option);
    });
}

document.getElementById('equipamento-dropdown').addEventListener('change', function() {
    const equipamentoId = this.value;
    const empresaId = document.getElementById('empresa-selector').value;

    if (!equipamentoId || !empresaId) {
        alert('Por favor, selecione um equipamento e uma empresa.');
        return;
    }

    // Buscar as portas livres do equipamento selecionado
    fetch(`/api/portas?equipamento_id=${equipamentoId}&empresa_id=${empresaId}`)
        .then(response => {
            if (!response.ok) {
                return Promise.reject('Falha ao buscar as portas livres.');
            }
            return response.json();
        })
        .then(data => {
            if (data.error) {
                alert(data.error);
                return;
            }

            if (!data || !Array.isArray(data)) {
                alert('Ocorreu um erro ao processar as portas livres.');
                return;
            }

            // Exibir as portas no dropdown de portas de destino
            const portaDestinoDropdown = document.getElementById('porta-destino-dropdown');
            portaDestinoDropdown.innerHTML = '<option value="">Selecione uma porta</option>'; // Resetar dropdown

            data.forEach(porta => {
                const option = document.createElement('option');
                option.value = porta.id;
                option.textContent = `${porta.nome} - ${porta.tipo} - ${porta.speed}`;
                portaDestinoDropdown.appendChild(option);
            });
        })
        .catch(error => {
        //    alert('Ocorreu um erro ao tentar buscar as portas livres.');
        });
});




// fun√ß√£o para filtrar os equipamentos e mostrar no DropDown
function filtrarEquipamentosPorEmpresa() {
    const empresaId = document.getElementById('empresa-selector').value;

    // Filtrar os equipamentos pela empresa selecionada
    const equipamentosFiltrados = empresaId
        ? nodes.filter(equipamento => equipamento.empresa === parseInt(empresaId))
        : [];  // Caso nenhum empresa seja selecionada, n√£o mostra equipamentos

    const equipamentosDropdown = document.getElementById('equipamento-dropdown');
    equipamentosDropdown.innerHTML = '<option value="">Selecione um equipamento</option>'; // Resetar dropdown

    // Adiciona as op√ß√µes de equipamentos ao dropdown
    equipamentosFiltrados.forEach(equipamento => {
        const option = document.createElement('option');
        option.value = equipamento.id;
        option.textContent = `${equipamento.nome} - ${equipamento.tipo} - ${equipamento.status}`;
        equipamentosDropdown.appendChild(option);
    });
}


function getCSRFToken() {
    return document.cookie.split('; ')
        .find(row => row.startsWith('csrftoken='))
        ?.split('=')[1];
}


    // Fun√ß√£o de arrasto
    function dragStarted(event, d) {
        d3.select(this).raise().classed('active', true);
    }

    function dragged(event, d) {
        d.x = event.x;
        d.y = event.y;
        d3.select(this).attr('transform', `translate(${d.x},${d.y})`);
        g.selectAll('.linha-conexao')
            .filter(l => l.source === d.id || l.target === d.id)
            .attr('d', function (d) {
                const x1 = nodes.find(node => node.id === d.source).x;
                const y1 = nodes.find(node => node.id === d.source).y;
                const x2 = nodes.find(node => node.id === d.target).x;
                const y2 = nodes.find(node => node.id === d.target).y;

                const curva = calcularCurva(x1, y1, x2, y2, 0);  // Atualiza a curva ao arrastar

                return d3.line()(curva);
            });
    }

    function dragEnded(event, d) {
        d3.select(this).classed('active', false);
        salvarPosicoes();
    }

function mostrarInformacoesConexao(d) {
    const equipamentoFonte = nodes.find(node => node.id === d.source);
    const equipamentoDestino = nodes.find(node => node.id === d.target);

    const portaFonte = d.porta_origem || 'N/A';
    const portaDestino = d.porta_destino || 'N/A';
    const portaObs = d.Obs || 'N/A';
    const portaId = d.porta_origem_id;

document.querySelector('.modal-conexao-header').innerHTML = `
    <div class="d-flex align-items-center">
        <i class="bi bi-plug-fill me-2 text-warning"></i>
        <h3 class="modal-title fw-bold text-warning mb-0">Conex√£o ${d.tipo}</h3>
    </div>
`;

document.querySelector('.modal-conexao-body').innerHTML = `
    <div class="px-3 py-2">
        <div class="mb-2 row">
            <label class="col-sm-2 col-form-label"><strong>Velocidade:</strong></label>
            <div class="col-sm-9">
                <input type="text" class="form-control" value="${d.speed}" readonly>
            </div>
        </div>
        <div class="mb-2 row">
            <label class="col-sm-2 col-form-label"><strong>Fonte:</strong></label>
            <div class="col-sm-9">
                <input type="text" class="form-control" value="${equipamentoFonte.nome} (${portaFonte})" readonly>
            </div>
        </div>
        <div class="mb-2 row">
            <label class="col-sm-2 col-form-label"><strong>Destino:</strong></label>
            <div class="col-sm-9">
                <input type="text" class="form-control" value="${equipamentoDestino.nome} (${portaDestino})" readonly>
            </div>
        </div>
        <div class="mb-2 row">
            <label class="col-sm-2 col-form-label"><strong>Obs.:</strong></label>
            <div class="col-sm-9 border rounded bg-light p-2" style="min-height: 80px;">
                ${portaObs}
            </div>
        </div>
    </div>`;


    document.getElementById('modalConexao').classList.add('show');
    document.getElementById('modalOverlayConexao').style.display = 'block';

    // Configura o bot√£o de excluir
    const excluirBtn = document.getElementById('excluirConexaoBtn');
    if (excluirBtn) {
        excluirBtn.replaceWith(excluirBtn.cloneNode(true));
        const novoExcluirBtn = document.getElementById('excluirConexaoBtn');

        novoExcluirBtn.onclick = function () {

            if (!portaId) {
                alert("Erro: ID da porta de origem n√£o est√° dispon√≠vel.");
                return;
            }

            if (confirm('Tem certeza que deseja excluir esta conex√£o?')) {
                fetch('/api/desconectar-portas/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ porta_id: portaId })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Conex√£o removida com sucesso!');
                        location.reload();
                    } else {
                        alert('Erro ao desconectar: ' + (data.error || 'Erro desconhecido.'));
                    }
                })
                .catch(() => {
                    alert('Erro na requisi√ß√£o.');
                });
            }
        };
    }

    // Configura o bot√£o de fechar modal
    const fecharBtn = document.getElementById('fecharConexaoBtn');
    if (fecharBtn) {
        fecharBtn.onclick = function () {
            document.getElementById('modalConexao').classList.remove('show');
            document.getElementById('modalOverlayConexao').style.display = 'none';
        };
    }
}


        // Fun√ß√£o para abrir o modal e buscar as informa√ß√µes do equipamento no backend
        function showModal(event, d) {
            // Requisi√ß√£o AJAX para buscar as informa√ß√µes do equipamento pelo ID
            fetch(`/api/equipamento/${d.id}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(data.error);  // Caso o equipamento n√£o seja encontrado
                    } else {
                        // Atualiza o modal com os dados recebidos
                        document.querySelector('.modal-header').textContent = `Equipamento ${data.nome}`;
                        document.getElementById('input-ip').value = data.ip || '';
                        document.getElementById('input-usuario').value = data.usuario || '';
                        document.getElementById('input-senha').value = data.senha || '';
                        document.getElementById('input-porta').value = data.porta || '';
                        document.getElementById('input-protocolo').value = data.protocolo || '';
                        document.getElementById('input-pop').value = data.pop || '';
                        document.getElementById('input-observacao').value = data.observacao || ''

                        // Exibe o modal
                        document.getElementById('modalEquipamento').classList.add('show');
                        document.getElementById('modalOverlay').style.display = 'block';
                    }
                })
                .catch(error => console.error('Erro ao buscar informa√ß√µes do equipamento:', error));
        }
            // Fechar modal
            document.getElementById('closeModal').addEventListener('click', () => {
                document.getElementById('modalEquipamento').classList.remove('show');
                document.getElementById('modalOverlay').style.display = 'none';
            });

        }

    // Executa a fun√ß√£o quando a empresa √© alterada
    document.getElementById('empresa-selector').addEventListener('change', renderMapa);


    // Atualizar o mapa a cada 30 segundos
    setInterval(() => {
        // Fechar o modal, se estiver aberto
        //if (document.getElementById('modalEquipamento').classList.contains('show')) {
        //    document.getElementById('modalEquipamento').classList.remove('show');
        //    document.getElementById('modalOverlay').style.display = 'none';
        //}

        atualizarMapa();
        renderMapa();

        // Aguarda um pequeno tempo para renderizar e reaplica o zoom
        setTimeout(() => {
            const svg = d3.select('#mapa').select('svg');
            svg.call(d3.zoom().transform, zoomTransform);
        }, 100);
    }, 30000);
</script>

<script>
    const userIsSenha = {{ user_is_senha|yesno:"true,false" }};

    function toggleModalPassword(inputId, btn) {
        if (!userIsSenha) {
            return;
        }

        const input = document.getElementById(inputId);
        if (input.type === "password") {
            input.type = "text";
            btn.textContent = "üôà";
        } else {
            input.type = "password";
            btn.textContent = "üëÅ";
        }
    }
</script>

</body>

{% endblock %}