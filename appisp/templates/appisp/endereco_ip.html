{% extends "admin/base_site.html" %}
{% load static %}

{% block content %}

<style>
    /* Estiliza todos os selects */
    select {
        width: 100%;
        padding: 8px;
        border: 1px solid #ced4da;
        border-radius: 5px;
        background-color: #000;
        font-size: 16px;
        appearance: none; /* Remove o estilo padrão do navegador */
        -webkit-appearance: none;
        -moz-appearance: none;
    }

    /* Adiciona uma seta personalizada no select */
    .form-group select {
        background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='24' height='24'><path fill='gray' d='M7 10l5 5 5-5z'/></svg>");
        background-repeat: no-repeat;
        background-position: right 10px center;
        background-size: 18px;
        padding-right: 30px;
    }

    /* Estiliza o hover e foco */
    select:hover, select:focus {
        border-color: #80bdff;
        box-shadow: 0 0 5px rgba(0, 123, 255, 0.25);
        outline: none;
    }

    /* Ajusta os selects dentro das colunas */
    .col-sm-7 select {
        width: 100%;
    }
</style>


<div class="row"></div>
<div class="col-12 col-lg-12">
    <div class="card">
        <div class="card-body">
            <form method="post" action="{% url 'endereco_ip'  %}" class="form-horizontal">
                {% csrf_token %}
                <h3>{% if endereco_ip %}Editar{% else %}Adicionar{% endif %} Endereço IP</h3>
                </br>
                <!-- Bloco -->
                <div class="form-group field-tipo">
                    <div class="row">
                        <div class="col-sm-2 text-left">
                            <label for="id_bloco" class="form-label">Bloco:</label>
                        </div>
                        <div class="col-sm-7">
                            {{ form.bloco }}
                        </div>
                    </div>
                </div>

                <!-- Equipamento -->
                <div class="form-group field-tipo">
                    <div class="row">
                        <div class="col-sm-2 text-left">
                            <label for="id_equipamento" class="form-label">Equipamento:</label>
                        </div>
                        <div class="col-sm-7">
                            {{ form.equipamento }}
                        </div>
                    </div>
                </div>

                <!-- Porta -->
                <div class="form-group field-tipo">
                    <div class="row">
                        <div class="col-sm-2 text-left">
                            <label for="id_porta" class="form-label">Porta:</label>
                        </div>
                        <div class="col-sm-7">
                            {{ form.porta }}
                        </div>
                    </div>
                </div>

                <!-- IP -->
                <div class="form-group field-tipo">
                    <div class="row">
                        <div class="col-sm-2 text-left">
                            <label for="id_ip" class="form-label">IP:</label>
                        </div>
                        <div class="col-sm-7">
                            {{ form.ip }}
                        </div>
                    </div>
                </div>

                <!-- Finalidade -->
                <div class="form-group field-tipo">
                    <div class="row">
                        <div class="col-sm-2 text-left">
                            <label for="id_finalidade" class="form-label">Finalidade:</label>
                        </div>
                        <div class="col-sm-7">
                            {{ form.finalidade }}
                        </div>
                    </div>
                </div>

                <!-- Next Hop -->
                <div class="form-group field-tipo">
                    <div class="row">
                        <div class="col-sm-2 text-left">
                            <label for="id_next_hop" class="form-label">Next Hop:</label>
                        </div>
                        <div class="col-sm-7">
                            {{ form.next_hop }}
                        </div>
                    </div>
                </div>

                <!-- Gateway -->
                <div class="form-group field-tipo">
                    <div class="row">
                        <div class="col-sm-2 text-left">
                            <label class="form-check-label" for="id_is_gateway">É o Gateway</label>
                        </div>
                        <div class="col-sm-7">
                            {{ form.is_gateway }}
                        </div>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary">Adicionar</button>
                <a href="/admin/" class="btn btn-secondary">Cancelar</a>
            </form>
            {% if form.errors %}
            <div class="alert alert-danger">
                <strong>Erros no formulário:</strong>
                <ul>
                    {% for field, errors in form.errors.items %}
                    <li><strong>{{ field }}:</strong> {{ errors|join:", " }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        </div>
    </div>

        <!-- Mostra a Tabela dos Blocos pertencentes ao bloco selecionado -->
        <div class="col-12 col-lg-12">
        <div class="card">
            <div class="card-body">
                <table id="tabela-sub-blocos" class="table table-striped" style="display: none;">

                    <thead>
                    <h4>Sub-blocos do Bloco Selecionado</h4>
                    <tr>
                        <th>Subnet</th>
                        <th>Máscara</th>
                        <th>Parente</th>
                        <th>Equipamento</th>
                        <th>Descrição</th>
                    </tr>
                    </thead>
                    <tbody id="tabela-sub-blocos-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="col-12 col-lg-12">
        <div class="card">
            <div class="card-body">
                <!-- Mostra a Tabela dos IPs pertencentes ao bloco selecionado -->
                <h4>IPs Cadastrados no Bloco</h4>
                <table id="tabela-ips" class="table table-striped" style="display: none;">
                    <thead>
                    <tr>
                        <th>IP</th>
                        <th>Equipamento</th>
                        <th>Porta</th>
                        <th>Finalidade</th>
                        <th>Next Hop</th>
                        <th>Gateway?</th>
                    </tr>
                    </thead>
                    <tbody id="tabela-ips-body"></tbody>
                </table>
            </div>
        </div>
    </div>

</div>

</div>

<!-- Script para filtrar as portas pelo Equipamento selecionado-->
<script>
document.addEventListener('DOMContentLoaded', function () {
    var equipamentoSelect = document.getElementById('id_equipamento');
    var portaSelect = document.getElementById('id_porta');

    function carregarPortas() {
        var equipamentoId = equipamentoSelect.value;

        if (equipamentoId) {
            portaSelect.innerHTML = '<option value="" selected>Carregando...</option>';
            fetch(`/ajax/portas_por_equipamento/${equipamentoId}/`)
                .then(response => response.json())
                .then(data => {
                    portaSelect.innerHTML = '<option value="" selected>Selecione uma porta</option>';
                    data.portas.forEach(function (porta) {
                        var option = document.createElement('option');
                        option.value = porta.id;
                        option.textContent = porta.nome;
                        portaSelect.appendChild(option);
                    });

                    // Mantém a seleção da porta após erro de validação
                    var portaSelecionada = "{{ form.porta.value }}";
                    if (portaSelecionada) {
                        portaSelect.value = portaSelecionada;
                    }
                });
        } else {
            portaSelect.innerHTML = '<option value="" selected>Selecione um equipamento primeiro</option>';
        }
    }

    // Executa ao carregar a página para manter seleção após erro de validação
    carregarPortas();

    // Atualiza portas sempre que um equipamento for selecionado
    equipamentoSelect.addEventListener('change', carregarPortas);
});

</script>

<script>
    document.getElementById('id_bloco').addEventListener('change', function () {
        var blocoId = this.value;

        // Elementos da tabela de sub-blocos
        var tabelaSubBlocos = document.getElementById('tabela-sub-blocos');
        var tbodySubBlocos = document.getElementById('tabela-sub-blocos-body');

        // Elementos da tabela de IPs
        var tabelaIps = document.getElementById('tabela-ips');
        var tbodyIps = document.getElementById('tabela-ips-body');

        // Limpa as tabelas antes de carregar novos dados
        tbodySubBlocos.innerHTML = '';
        tbodyIps.innerHTML = '';

        if (blocoId) {
            // Buscar Sub-Blocos
            fetch(`/ajax/sub_blocos_por_bloco/${blocoId}/`)
                .then(response => response.json())
                .then(data => {
                    data.sub_blocos.forEach(function (sub_bloco) {
                        var bloco_cidr = sub_bloco.bloco_cidr;
                        var descricao = sub_bloco.descrcao || '';
                        var [ip, cidr] = bloco_cidr.split('/');
                        var mascara = cidrParaMascara(cidr);

                        var parente = sub_bloco.parent__bloco_cidr || 'N/A';
                        var equipamento = sub_bloco.equipamento__nome || 'N/A';

                        var row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${bloco_cidr}</td>
                            <td>${mascara}</td>
                            <td>${parente}</td>
                            <td>${equipamento}</td>
                            <td>${descricao}</td>
                        `;
                        tbodySubBlocos.appendChild(row);
                    });

                    tabelaSubBlocos.style.display = data.sub_blocos.length > 0 ? 'table' : 'none';
                })
                .catch(error => console.error('Erro ao buscar sub-blocos:', error));

            // Buscar IPs
            fetch(`/ajax/ips_por_bloco/${blocoId}/`)
                .then(response => response.json())
                .then(data => {
                    data.ips.forEach(function (ip) {
                        var row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${ip.ip}</td>
                            <td>${ip.equipamento__nome || ''}</td>
                            <td>${ip.porta__nome || ''}</td>
                            <td>${ip.finalidade || ''}</td>
                            <td>${ip.next_hope || ''}</td>
                            <td>${ip.is_gateway ? 'Sim' : 'Não'}</td>
                            <td>
                                <button class="btn-alterar" data-ip='${JSON.stringify(ip)}'>Alterar</button>
                            </td>
                        `;
                        tbodyIps.appendChild(row);
                    });

                    tabelaIps.style.display = data.ips.length > 0 ? 'table' : 'none';

                    // Adiciona evento para os botões de alteração
                    document.querySelectorAll('.btn-alterar').forEach(btn => {
                        btn.addEventListener('click', function () {
                            var ipData = JSON.parse(this.getAttribute('data-ip'));
                            preencherFormulario(ipData);
                        });
                    });

                })
                .catch(error => console.error('Erro ao buscar IPs:', error));
        } else {
            tabelaSubBlocos.style.display = 'none';
            tabelaIps.style.display = 'none';
        }
    });

    // Função para converter sufixo CIDR para máscara de sub-rede
    function cidrParaMascara(cidr) {
        var cidrMap = {
            "0": "0.0.0.0", "1": "128.0.0.0", "2": "192.0.0.0", "3": "224.0.0.0",
            "4": "240.0.0.0", "5": "248.0.0.0", "6": "252.0.0.0", "7": "254.0.0.0",
            "8": "255.0.0.0", "9": "255.128.0.0", "10": "255.192.0.0", "11": "255.224.0.0",
            "12": "255.240.0.0", "13": "255.248.0.0", "14": "255.252.0.0", "15": "255.254.0.0",
            "16": "255.255.0.0", "17": "255.255.128.0", "18": "255.255.192.0", "19": "255.255.224.0",
            "20": "255.255.240.0", "21": "255.255.248.0", "22": "255.255.252.0", "23": "255.255.254.0",
            "24": "255.255.255.0", "25": "255.255.255.128", "26": "255.255.255.192", "27": "255.255.255.224",
            "28": "255.255.255.240", "29": "255.255.255.248", "30": "255.255.255.252", "31": "255.255.255.254",
            "32": "255.255.255.255"
        };
        return cidrMap[cidr] || "N/A";
    }

    // Função para preencher o formulário com os dados do IP selecionado
    function preencherFormulario(ipData) {
        document.getElementById('id_ip').value = ipData.ip;
        document.getElementById('id_equipamento').value = ipData.equipamento__nome;
        document.getElementById('id_finalidade').value = ipData.finalidade;
        document.getElementById('id_next_hop').value = ipData.next_hop;

        // Marcar checkbox de Gateway se necessário
        document.getElementById('id_is_gateway').checked = ipData.is_gateway;

        // Atualiza a lista de portas para carregar corretamente a porta selecionada
        carregarPortas(() => {
            document.getElementById('id_porta').value = ipData.porta;
        });
        // console.log("Equipamento selecionado:", ipData.equipamento__nome);
    }

    function carregarPortas(callback = null) {
        var equipamentoId = document.getElementById('id_equipamento').value;
        var portaSelect = document.getElementById('id_porta');

        if (equipamentoId) {
            portaSelect.innerHTML = '<option value="" selected>Carregando...</option>';
            fetch(`/ajax/portas_por_equipamento/${equipamentoId}/`)
                .then(response => response.json())
                .then(data => {
                    portaSelect.innerHTML = '<option value="" selected>Selecione uma porta</option>';
                    data.portas.forEach(function (porta) {
                        var option = document.createElement('option');
                        option.value = porta.id;
                        option.textContent = porta.nome;
                        portaSelect.appendChild(option);
                    });

                    // Se houver um callback, chama após as portas serem carregadas
                    if (callback) {
                        callback();
                    }
                });
        } else {
            portaSelect.innerHTML = '<option value="" selected>Selecione um equipamento primeiro</option>';
        }
    }

</script>

<!-- Script para selecionar automaticamente o equipamento -->
<script>
document.addEventListener("DOMContentLoaded", function() {
    const equipamentoNome = "{{ ip.equipamento__nome }}".trim().toLowerCase();
    const equipamentoSelect = document.getElementById('id_equipamento');

    //console.log("Nome vindo do backend:", equipamentoNome);

    for (let option of equipamentoSelect.options) {
       // console.log("Opção disponível:", option.text.trim().toLowerCase());

        if (option.text.trim().toLowerCase() === equipamentoNome) {
            equipamentoSelect.value = option.value;
            //console.log("Equipamento selecionado:", option.text);
            break;
        }
    }
});
</script>

{% endblock %}
