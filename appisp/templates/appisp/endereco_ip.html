{% extends "admin/base_site.html" %}
{% load static %}

{% block content %}

  <h1>{% if endereco_ip %}Editar{% else %}Adicionar{% endif %} Endereço IP</h1>

<div class="row"></div>
    <div class="col-12 col-lg-9">
        <div class="card">
            <div class="card-body">
        <form method="post" action="{% url 'admin:adicionar_lote' %}" class="form-horizontal">
            {% csrf_token %}

                    <!-- Bloco -->
                      <div class="form-group field-tipo">
                          <div class="row">
                              <div class="col-sm-3 text-left">
                                  <label for="id_bloco" class="form-label">Bloco:</label>
                              </div>
                              <div class="col-sm-7">
                                  {{ form.bloco }}
                              </div>
                          </div>
                      </div>

                    <!-- Equipamento -->
                      <div class="form-group field-tipo">
                          <div class="row">
                              <div class="col-sm-3 text-left">
                                  <label for="id_equipamento" class="form-label">Equipamento:</label>
                              </div>
                              <div class="col-sm-7">
                                  {{ form.equipamento }}
                              </div>
                          </div>
                      </div>

                    <!-- Porta -->
                    <div class="form-group field-tipo">
                          <div class="row">
                              <div class="col-sm-3 text-left">
                                  <label for="id_porta" class="form-label">Porta:</label>
                              </div>
                              <div class="col-sm-7">
                                  {{ form.porta }}
                              </div>
                          </div>
                      </div>

                    <!-- IP -->
                    <div class="form-group field-tipo">
                          <div class="row">
                              <div class="col-sm-3 text-left">
                                  <label for="id_ip" class="form-label">IP:</label>
                              </div>
                              <div class="col-sm-7">
                                  {{ form.ip }}
                              </div>
                          </div>
                      </div>

                    <!-- Finalidade -->
                    <div class="form-group field-tipo">
                          <div class="row">
                              <div class="col-sm-3 text-left">
                                  <label for="id_finalidade" class="form-label">Finalidade:</label>
                              </div>
                              <div class="col-sm-7">
                                  {{ form.finalidade }}
                              </div>
                          </div>
                      </div>

                    <!-- Next Hop -->
                    <div class="form-group field-tipo">
                          <div class="row">
                              <div class="col-sm-3 text-left">
                                  <label for="id_next_hop" class="form-label">Next Hop:</label>
                              </div>
                              <div class="col-sm-7">
                                  {{ form.next_hop }}
                              </div>
                          </div>
                      </div>

                    <!-- Gateway -->
                    <div class="form-group field-tipo">
                          <div class="row">
                              <div class="col-sm-3 text-left">
                                  <label class="form-check-label" for="id_is_gateway">É o Gateway</label>
                              </div>
                              <div class="col-sm-7">
                                  {{ form.is_gateway }}
                              </div>
                          </div>
                      </div>

            <button type="submit" class="btn btn-primary">Adicionar</button>
            <a href="../" class="btn btn-secondary">Cancelar</a>
        </form>
                {% if form.errors %}
                    <div class="alert alert-danger">
                        <strong>Erros no formulário:</strong>
                        <ul>
                            {% for field, errors in form.errors.items %}
                                <li><strong>{{ field }}:</strong> {{ errors|join:", " }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                {% endif %}
        </div>
        </div>
 <h3>IPs Cadastrados no Bloco</h3>
<table id="tabela-ips" class="table table-striped" style="display: none;">
    <thead>
        <tr>
            <th>IP</th>
            <th>Finalidade</th>
            <th>Equipamento</th>
        </tr>
    </thead>
    <tbody id="tabela-ips-body"></tbody>
</table>
    </div>

  <script>
    // Função para filtrar portas com base no equipamento selecionado
    document.getElementById('id_equipamento').addEventListener('change', function () {
      var equipamentoId = this.value;
      var portaSelect = document.getElementById('id_porta');

      // Limpa as portas atuais
      portaSelect.innerHTML = '';

      if (equipamentoId) {
        // Fazer a requisição AJAX para buscar as portas relacionadas ao equipamento
        fetch(`/ajax/portas_por_equipamento/${equipamentoId}/`)
          .then(response => response.json())
          .then(data => {
            // Preencher as opções de porta
            data.portas.forEach(function (porta) {
              var option = document.createElement('option');
              option.value = porta.id;
              option.textContent = porta.nome;
              portaSelect.appendChild(option);
            });
          });
      }
    });
  </script>
</div>

<script>
document.getElementById('id_bloco').addEventListener('change', function () {
    var blocoId = this.value;
    var tabelaIps = document.getElementById('tabela-ips');
    var tbody = document.getElementById('tabela-ips-body');

    tbody.innerHTML = '';  // Limpa a tabela antes de carregar novos dados

    if (blocoId) {
        fetch(`/ajax/ips_por_bloco/${blocoId}/`)
            .then(response => response.json())
            .then(data => {
                data.ips.forEach(function (ip) {
                    var row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${ip.ip}</td>
                        <td>${ip.finalidade || 'N/A'}</td>
                        <td>${ip.equipamento__nome || 'N/A'}</td>
                    `;
                    tbody.appendChild(row);
                });

                // Exibir a tabela somente se houver IPs cadastrados
                tabelaIps.style.display = data.ips.length > 0 ? 'table' : 'none';
            });
    } else {
        tabelaIps.style.display = 'none'; // Esconder a tabela se nenhum bloco for selecionado
    }
});
</script>
{% endblock %}
